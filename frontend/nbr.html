<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBR Dashboard - Taxparency</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1><a href="index.html" style="color: white; text-decoration: none;">üîç Taxparency</a></h1>
                <p class="tagline">NBR (Tax Authority) Dashboard</p>
            </div>
            <div class="blockchain-status">
                <div class="status-indicator" id="blockchainStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="hero">
                <h2>Welcome, NBR Official</h2>
                <p class="hero-description">
                    As a National Bureau of Revenue official, you have the authority to validate tax submissions, 
                    monitor revenue collection, and ensure tax compliance across the blockchain platform.
                    All your validation actions are permanently recorded for transparency and accountability.
                </p>
            </div>

            <!-- Dashboard Stats -->
            <section class="stats-overview">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSubmissions">Loading...</div>
                        <div class="stat-label">Total Tax Submissions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pendingValidations">Loading...</div>
                        <div class="stat-label">Pending Validations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="validatedAmount">Loading...</div>
                        <div class="stat-label">Total Validated Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="validationRate">Loading...</div>
                        <div class="stat-label">Validation Success Rate</div>
                    </div>
                </div>
            </section>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                
                <!-- Revenue Overview -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Revenue Overview</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="flex justify-between mb-2">
                                <span>Total Tax Revenue:</span>
                                <span id="totalRevenue">Loading...</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span>Validated Revenue:</span>
                                <span id="totalValidatedRevenue">Loading...</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span>Budget Balance:</span>
                                <span id="budgetBalance">Loading...</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Collection Efficiency:</span>
                                <span id="collectionEfficiency">Loading...</span>
                            </div>
                        </div>
                        
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md);">
                            <h4 style="margin-bottom: 0.5rem; font-size: 1rem;">NBR Authority Actions:</h4>
                            <ul style="font-size: 0.875rem; color: var(--text-secondary);">
                                <li>‚úì Validate citizen tax submissions</li>
                                <li>‚úì Monitor revenue collection patterns</li>
                                <li>‚úì Generate audit reports</li>
                                <li>‚úì Track budget utilization</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Quick Actions</h3>
                    </div>
                    <div class="card-body">
                        <div style="background: var(--warning-bg); color: var(--warning-color); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">‚ö†Ô∏è Authority Notice</h4>
                            <p style="margin: 0; font-size: 0.875rem;">As an NBR official, your validation decisions are immutable and publicly auditable. Exercise due diligence in all tax validations.</p>
                        </div>
                        
                        <div class="flex flex-col gap-2">
                            <button class="btn btn-primary" onclick="scrollToSection('pendingSubmissions')">
                                üìã Review Pending Submissions
                            </button>
                            <button class="btn btn-secondary" onclick="scrollToSection('validationHistory')">
                                üìä View Validation History
                            </button>
                            <button class="btn btn-secondary" onclick="scrollToSection('revenueAudit')">
                                üîç Revenue Audit Trail
                            </button>
                            <button class="btn btn-secondary" onclick="generateReport()">
                                üìë Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Tax Submissions -->
            <section class="mb-4" id="pendingSubmissions">
                <h3 class="mb-3">Pending Tax Submissions for Validation</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Submission ID</th>
                                <th>Citizen Address</th>
                                <th>Amount (ETH)</th>
                                <th>Submitted Date</th>
                                <th>Documents</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingSubmissionsTable">
                            <tr>
                                <td colspan="6" class="text-center">Loading pending submissions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Recent Validation History -->
            <section class="mb-4" id="validationHistory">
                <h3 class="mb-3">Recent Validation History</h3>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Submission ID</th>
                                <th>Citizen</th>
                                <th>Amount (ETH)</th>
                                <th>Validation Date</th>
                                <th>Status</th>
                                <th>Validated By</th>
                            </tr>
                        </thead>
                        <tbody id="validationHistoryTable">
                            <tr>
                                <td colspan="6" class="text-center">Loading validation history...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Revenue Audit Trail -->
            <section class="mb-4" id="revenueAudit">
                <h3 class="mb-3">Revenue Audit Trail</h3>
                <div class="card">
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);" id="auditTotalRevenue">Loading...</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Total Revenue</div>
                            </div>
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);" id="auditValidatedRevenue">Loading...</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Validated Revenue</div>
                            </div>
                            <div class="text-center">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--info-color);" id="auditBudgetUsed">Loading...</div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary);">Budget Utilized</div>
                            </div>
                        </div>
                        
                        <div id="auditTrailList" class="loading">
                            Loading audit trail...
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>NBR Authority</h4>
                    <p>The National Bureau of Revenue ensures transparent and accountable tax collection through blockchain technology.</p>
                </div>
                <div class="footer-section">
                    <h4>Responsibilities</h4>
                    <ul>
                        <li>Validate tax submissions fairly</li>
                        <li>Maintain audit transparency</li>
                        <li>Monitor revenue patterns</li>
                        <li>Ensure compliance standards</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Compliance</h4>
                    <p>All NBR actions are recorded immutably on the blockchain for public transparency and accountability.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Validation Modal -->
    <div id="validationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Tax Submission Validation</h3>
                </div>
                <div class="card-body">
                    <div id="validationDetails">
                        <!-- Details will be populated here -->
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Validation Decision</label>
                        <div class="flex gap-2">
                            <button class="btn btn-success" id="approveBtn">Approve & Validate</button>
                            <button class="btn btn-danger" id="rejectBtn">Reject Submission</button>
                            <button class="btn btn-secondary" onclick="closeValidationModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.6.0/dist/ethers.umd.min.js"></script>
    <script src="js/web3-init.js"></script>
    <script src="js/contract-calls.js"></script>
    <script>
        let userAddress = null;
        let currentValidationId = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializeWeb3();
                userAddress = await window.signer.getAddress();
                
                await loadDashboardData();
                await loadPendingSubmissions();
                await loadValidationHistory();
                await loadRevenueAuditTrail();
                
                setupEventListeners();
            } catch (error) {
                console.error('Initialization error:', error);
                updateConnectionStatus('disconnected', 'Connection Failed');
            }
        });

        async function loadDashboardData() {
            try {
                // Load revenue data
                const revenueData = await getTotalRevenue();
                document.getElementById('totalRevenue').textContent = 
                    formatEther(revenueData.total) + ' ETH';
                document.getElementById('totalValidatedRevenue').textContent = 
                    formatEther(revenueData.validated) + ' ETH';

                // Load budget data
                const budgetSummary = await getBudgetSummary();
                document.getElementById('budgetBalance').textContent = 
                    formatEther(budgetSummary.currentBalance) + ' ETH';

                // Calculate collection efficiency
                const efficiency = revenueData.total.gt(0) ? 
                    (revenueData.validated.mul(100).div(revenueData.total)).toString() + '%' : '0%';
                document.getElementById('collectionEfficiency').textContent = efficiency;

                // Update stats cards
                document.getElementById('validatedAmount').textContent = 
                    formatEther(revenueData.validated) + ' ETH';

                // Load pending submissions count
                const pendingIds = await getPendingValidations();
                document.getElementById('pendingValidations').textContent = pendingIds.length;
                
                // Calculate validation rate (placeholder)
                document.getElementById('validationRate').textContent = '95%'; // This would be calculated from actual data
                document.getElementById('totalSubmissions').textContent = 'Loading...'; // This would need a new contract method

                // Update audit section
                document.getElementById('auditTotalRevenue').textContent = formatEther(revenueData.total) + ' ETH';
                document.getElementById('auditValidatedRevenue').textContent = formatEther(revenueData.validated) + ' ETH';
                
                const budgetUsed = budgetSummary.totalDeducted;
                document.getElementById('auditBudgetUsed').textContent = formatEther(budgetUsed) + ' ETH';

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Set error states
                document.getElementById('totalRevenue').textContent = 'Error';
                document.getElementById('totalValidatedRevenue').textContent = 'Error';
                document.getElementById('budgetBalance').textContent = 'Error';
            }
        }

        async function loadPendingSubmissions() {
            try {
                const pendingIds = await getPendingValidations();
                const tableBody = document.getElementById('pendingSubmissionsTable');
                
                if (pendingIds.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">No pending submissions for validation.</td>
                        </tr>
                    `;
                    return;
                }

                const submissions = await Promise.all(
                    pendingIds.map(id => getTaxSubmission(id))
                );

                tableBody.innerHTML = submissions.map(submission => `
                    <tr>
                        <td>#${submission.id}</td>
                        <td>${formatAddress(submission.citizen)}</td>
                        <td>${formatEther(submission.amount)} ETH</td>
                        <td>${formatTimestamp(submission.timestamp)}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewDocuments('${submission.documentHash}')">
                                View Docs
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openValidationModal(${submission.id})">
                                Validate
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading pending submissions:', error);
                document.getElementById('pendingSubmissionsTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="error">Error loading pending submissions</td>
                    </tr>
                `;
            }
        }

        async function loadValidationHistory() {
            // This would need to be implemented by tracking validation events
            // For now, showing placeholder
            document.getElementById('validationHistoryTable').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">Validation history tracking will be implemented with blockchain event listeners.</td>
                </tr>
            `;
        }

        async function loadRevenueAuditTrail() {
            try {
                // In a real implementation, this would show all budget deductions and revenue entries
                const deductions = await getAllDeductions();
                const container = document.getElementById('auditTrailList');
                
                if (deductions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center">
                            <h4>No Budget Deductions Yet</h4>
                            <p>Budget deductions will appear here when projects start utilizing funds.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project ID</th>
                                    <th>Amount (ETH)</th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Authorized By</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${deductions.map(deduction => `
                                    <tr>
                                        <td>#${deduction.projectId}</td>
                                        <td>${formatEther(deduction.amount)} ETH</td>
                                        <td>${formatTimestamp(deduction.timestamp)}</td>
                                        <td>${deduction.description}</td>
                                        <td>${formatAddress(deduction.authorizedBy)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading audit trail:', error);
                document.getElementById('auditTrailList').innerHTML = 
                    '<div class="error">Error loading audit trail</div>';
            }
        }

        function setupEventListeners() {
            // Setup modal event listeners
            document.getElementById('approveBtn').addEventListener('click', () => handleValidation(true));
            document.getElementById('rejectBtn').addEventListener('click', () => handleValidation(false));
        }

        async function openValidationModal(submissionId) {
            try {
                currentValidationId = submissionId;
                const submission = await getTaxSubmission(submissionId);
                
                const modal = document.getElementById('validationModal');
                const detailsContainer = document.getElementById('validationDetails');
                
                detailsContainer.innerHTML = `
                    <div class="mb-3">
                        <h4>Submission Details</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <strong>Submission ID:</strong> #${submission.id}
                            </div>
                            <div>
                                <strong>Amount:</strong> ${formatEther(submission.amount)} ETH
                            </div>
                            <div>
                                <strong>Citizen:</strong> ${formatAddress(submission.citizen)}
                            </div>
                            <div>
                                <strong>Submitted:</strong> ${formatTimestamp(submission.timestamp)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <strong>Documents:</strong> 
                        <button class="btn btn-sm btn-secondary ml-2" onclick="viewDocuments('${submission.documentHash}')">
                            View Documents
                        </button>
                    </div>
                    
                    <div style="background: var(--warning-bg); color: var(--warning-color); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                        <strong>‚ö†Ô∏è Validation Warning:</strong> This action is permanent and will be recorded on the blockchain. 
                        Please review all documentation carefully before making a decision.
                    </div>
                `;
                
                modal.style.display = 'flex';
                
            } catch (error) {
                console.error('Error opening validation modal:', error);
                alert('Error loading submission details: ' + error.message);
            }
        }

        function closeValidationModal() {
            document.getElementById('validationModal').style.display = 'none';
            currentValidationId = null;
        }

        async function handleValidation(approved) {
            if (!currentValidationId) return;
            
            try {
                const approveBtn = document.getElementById('approveBtn');
                const rejectBtn = document.getElementById('rejectBtn');
                
                approveBtn.disabled = true;
                rejectBtn.disabled = true;
                
                if (approved) {
                    approveBtn.textContent = 'Validating...';
                } else {
                    rejectBtn.textContent = 'Rejecting...';
                }
                
                await validateTaxSubmission(currentValidationId, approved);
                
                alert(`Tax submission ${approved ? 'approved' : 'rejected'} successfully!`);
                closeValidationModal();
                
                // Reload data
                await loadDashboardData();
                await loadPendingSubmissions();
                await loadValidationHistory();
                
            } catch (error) {
                console.error('Error handling validation:', error);
                alert('Error processing validation: ' + error.message);
            } finally {
                // Reset button states
                const approveBtn = document.getElementById('approveBtn');
                const rejectBtn = document.getElementById('rejectBtn');
                
                approveBtn.disabled = false;
                rejectBtn.disabled = false;
                approveBtn.textContent = 'Approve & Validate';
                rejectBtn.textContent = 'Reject Submission';
            }
        }

        function viewDocuments(documentHash) {
            // In a real implementation, this would retrieve and display documents from IPFS
            alert(`Document Hash: ${documentHash}\n\nIn a real implementation, this would open the IPFS documents for review.`);
        }

        function generateReport() {
            // In a real implementation, this would generate a comprehensive report
            alert('Report generation feature will be implemented. This would create downloadable reports showing revenue collection, validation statistics, and audit trails.');
        }

        function scrollToSection(sectionId) {
            document.getElementById(sectionId).scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
    </script>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .grid {
            display: grid;
        }
        
        .grid-cols-2 {
            grid-template-columns: 1fr 1fr;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .ml-2 {
            margin-left: 0.5rem;
        }
    </style>
</body>
</html>
